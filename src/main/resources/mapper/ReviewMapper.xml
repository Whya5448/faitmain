<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
					
<mapper namespace="com.faitmain.domain.product.mapper.ReviewMapper">

	<resultMap id="reviewSelectMap" type="com.faitmain.domain.product.domain.Review">
		<result property="reviewNumber" 		column="review_number" 		jdbcType="INTEGER"/>
		<result property="reviewContent"		column="review_content" 	jdbcType="VARCHAR" />
		<result property="reviewImage" 			column="review_image" 		jdbcType="VARCHAR" />
		<result property="rating" 				column="rating" 			jdbcType="INTEGER" />
		<result property="userId" 				column="user_id"			jdbcType="VARCHAR" />
		<result property="reviewRegDate" 		column="reg_date" 			jdbcType="DATE" />
		<result property="orderNumber" 			column="order_number" 		jdbcType="INTEGER" />
				
		<association property="orderProduct"  javaType="com.faitmain.domain.product.domain.Product">
			<id property="productNumber" 			column="order_number" 		jdbcType="INTEGER"/>			
			<result property="productName"			column="product_name" 			jdbcType="VARCHAR" />
			<result property="productGroupNumber" 	column="product_group_number" 	jdbcType="INTEGER" />
		</association>				
	</resultMap>
			
	<!-- 리뷰 등록 -->
	<insert id="addReview" parameterType="com.faitmain.domain.product.domain.Review">	
		INSERT
		INTO review(order_number, review_content, review_image, rating, reg_date, user_id )
		VALUES (#{orderNumber}, #{reviewContent}, #{reviewImage:VARCHAR}, #{rating}, now(), #{userId})
	</insert>
	
	<!-- 리뷰 상세 조회 -->	    
    <select id="getReview" parameterType="int"	resultMap="reviewSelectMap">
    	SELECT r.*, od.*
		FROM review r, (SELECT o.order_number, p.product_number, p.product_name
				FROM `order` o, product p
				WHERE o.product_number = p.product_number) od
		WHERE r.review_number = #{reviewNumber}
    </select>
	
	<!-- 리뷰 목록 조회 (현재 search 없어서 if문 수정 필요) -->
	<select  id="getReviewList"  parameterType="com.faitmain.global.common.Search"	resultMap="reviewSelectMap">
	  	SELECT *
	  	FROM (	SELECT inner_table.* , @ROWNUM := @ROWNUM+1 AS row_seq
	  			FROM		(	
	  							SELECT r.*, od.*
								FROM review r, (SELECT p.product_number, p.product_group_number, p.product_name
												FROM `order` o, product p
												WHERE o.product_number = p.product_number) od	  			
								<where>					
									
									<if test="searchCondition != null">
										<if test="searchCondition == 회원이 조회 and searchKeyword !='' ">
							 				AND r.user_id = #{searchKeyword}
										</if> 
										<if test="searchCondition == 상품목록에서 조회 - 옵션 없을 때 and searchKeyword !='' ">
							 				AND od.product_number = #{searchKeyword}
										</if>										
										<if test="searchCondition == 상품목록에서 조회 - 옵션 있을 때 and searchKeyword !='' ">
							 				AND od.product_group_number = #{searchKeyword}
										</if>																			
									</if>
									
								</where>
						ORDER BY r.reg_date DESC ) inner_table
				WHERE (@ROWNUM:=0)=0 limit #{endRowNum} ) result_table
		WHERE row_seq BETWEEN #{startRowNum} AND #{endRowNum} 
	 </select>
	 
	 <!-- SQL : SELECT ROW Count (현재 search 없음) -->	 
	<select  id="getTotalCount"  parameterType="com.faitmain.global.common.Search"	 resultType="int">
	  	SELECT COUNT(*)
	  	FROM(	SELECT r.*, od.*
				FROM review r, (SELECT p.product_number, p.product_group_number, p.product_name
								FROM `order` o, product p
								WHERE o.product_number = p.product_number) od	  			
				<where>					
					
					<if test="searchCondition != null">
						<if test="searchCondition == 회원이 조회 and searchKeyword !='' ">
			 				AND r.user_id = #{searchKeyword}
						</if> 
						<if test="searchCondition == 상품목록에서 조회 - 옵션 없을 때 and searchKeyword !='' ">
			 				AND od.product_number = #{searchKeyword}
						</if>										
						<if test="searchCondition == 상품목록에서 조회 - 옵션 있을 때 and searchKeyword !='' ">
			 				AND od.product_group_number = #{searchKeyword}
						</if>																			
					</if>
					
				</where>
			) countTable						
	 </select> 

	<!-- 리뷰 수정 -->	
	<update id="updateReview" parameterType="com.faitmain.domain.product.domain.Review" >
		UPDATE review
		<set>
			review_content = #{reviewContent},
			review_image = #{reviewImage:VARCHAR},
			rating = #{rating}
		</set>
		WHERE review_number = #{reviewNumber}
	</update>
			
	<!-- 리뷰 삭제 -->
	<delete id="deleteReview" parameterType="int">
    	DELETE FROM review WHERE review_number = #{reviewNumber}
  	</delete>
  	
</mapper>