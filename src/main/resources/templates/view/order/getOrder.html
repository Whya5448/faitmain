<!DOCTYPE html>
<html layout:decorate = "~{layout/default_layout}"
      xmlns:layout = "http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <!--  고유 CSS 추가 -->

    <style>
    </style>

    <!--  고유 스크립트 추가 -->
    <!-- iamport.payment.js -->
    <script src = "https://cdn.iamport.kr/js/iamport.payment-1.1.5.js" type = "text/javascript"></script>
    <script>

        /** 결제 **/

        // 결제 금액, 구매자의 이름, 이메일
        const priceAmount = $('#totalPrice').val();
        const buyerMemberEmail = $('#memberEmail').val();
        const buyerMemberName = $('#memberName').val();
        // const form = document.getElementById("payment");

        console.log(priceAmount);
        console.log(buyerMemberName);
        console.log(buyerMemberEmail);
        const IMP = window.IMP;
        IMP.init("imp76668016");

        // 결제
        function requestPay(data) {

            IMP.request_pay({ // param
                    pg: "kakaopay.TC0ONETIME",
                    pay_method: "card",
                    merchant_uid: 'merchant_' + new Date().getTime(),
                    name: "Helpring 강의",
                    amount: priceAmount,
                    buyer_email: buyerMemberEmail,
                    buyer_name: buyerMemberName,
                },
                function (rsp) { // callback

                    /** 결제 검증 **/
                    $.ajax({
                        type: 'POST',
                        url: '/verifyIamport/' + rsp.imp_uid,
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader(header, token);
                        }
                    }).done(function (result) {

                        // rsp.paid_amount와 result.response.amount(서버 검증) 비교 후 로직 실행
                        if (rsp.paid_amount === result.response.amount) {
                            alert("결제가 완료되었습니다.");
                            $.ajax({
                                type: 'POST',
                                url: '/order/getOrder',
                                beforeSend: function (xhr) {
                                    xhr.setRequestHeader(header, token);
                                }
                            }).done(function () {
                                window.location.reload();
                            }).fail(function (error) {
                                alert(JSON.stringify(error));
                            })
                        } else {
                            alert("결제에 실패했습니다." + "에러코드 : " + rsp.error_code + "에러 메시지 : " + rsp.error_message);

                        }
                    })
                });
        }
    </script>


    <script src = "//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        //본 예제에서는 도로명 주소 표기 방식에 대한 법령에 따라, 내려오는 데이터를 조합하여 올바른 주소를 구성하는 방법을 설명합니다.
        function sample4_execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                    // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
                    // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                    var roadAddr = data.roadAddress; // 도로명 주소 변수
                    var extraRoadAddr = ''; // 참고 항목 변수

                    // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                    // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                    if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
                        extraRoadAddr += data.bname;
                    }
                    // 건물명이 있고, 공동주택일 경우 추가한다.
                    if (data.buildingName !== '' && data.apartment === 'Y') {
                        extraRoadAddr += (extraRoadAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                    }
                    // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                    if (extraRoadAddr !== '') {
                        extraRoadAddr = ' (' + extraRoadAddr + ')';
                    }

                    // 우편번호와 주소 정보를 해당 필드에 넣는다.
                    document.getElementById('sample4_postcode').value = data.zonecode;
                    document.getElementById("sample4_roadAddress").value = roadAddr;
                    document.getElementById("sample4_jibunAddress").value = data.jibunAddress;

                    // 참고항목 문자열이 있을 경우 해당 필드에 넣는다.
                    if (roadAddr !== '') {
                        document.getElementById("sample4_extraAddress").value = extraRoadAddr;
                    } else {
                        document.getElementById("sample4_extraAddress").value = '';
                    }

                    var guideTextBox = document.getElementById("guide");
                    // 사용자가 '선택 안함'을 클릭한 경우, 예상 주소라는 표시를 해준다.
                    if (data.autoRoadAddress) {
                        var expRoadAddr = data.autoRoadAddress + extraRoadAddr;
                        guideTextBox.innerHTML = '(예상 도로명 주소 : ' + expRoadAddr + ')';
                        guideTextBox.style.display = 'block';

                    } else if (data.autoJibunAddress) {
                        var expJibunAddr = data.autoJibunAddress;
                        guideTextBox.innerHTML = '(예상 지번 주소 : ' + expJibunAddr + ')';
                        guideTextBox.style.display = 'block';
                    } else {
                        guideTextBox.innerHTML = '';
                        guideTextBox.style.display = 'none';
                    }
                }
            }).open();
        }
    </script>


</head>

<body>

<!-- Page Content-->
<article class = "py-5" layout:fragment = "content">


    <div class = "container-fluid">
        <div class = "row">
            <div class = "col-md-12">
                <div class = "row">
                    <div class = "col-md-2">
                    </div>
                    <div class = "col-md-8">
                        <div class = "row">
                            <div class = "col-md-12" id = "payment">
                                <h3 class = "text-center">
                                    주문 & 결제
                                </h3>
                            </div>
                        </div>
                        <div class = "row">
                            <div class = "col-md-4">

                                <address class = "text-center">
                                    <strong>Twitter, Inc.</strong><br> 795 Folsom Ave, Suite 600<br> San Francisco, CA
                                                                       94107<br> <abbr title = "Phone">P:</abbr> (123)
                                                                       456-7890
                                </address>
                            </div>
                            <div class = "col-md-8">
                                <form class = "form-inline" role = "form">
                                    <div class = "form-group">

                                        <input id = "sample4_postcode" placeholder = "우편번호" type = "text">
                                        <input onclick = "sample4_execDaumPostcode()" type = "button" value = "우편번호 찾기"><br>
                                        <input id = "sample4_roadAddress" placeholder = "도로명주소" type = "text">
                                        <input id = "sample4_jibunAddress" placeholder = "지번주소" type = "text">
                                        <span id = "guide" style = "color:#999;display:none"></span>
                                        <input id = "sample4_detailAddress" placeholder = "상세주소" type = "text">
                                        <input id = "sample4_extraAddress" placeholder = "참고항목" type = "text">
                                    </div>
                                </form>
                            </div>

                        </div>
                        <div class = "row">
                            <div class = "col-md-8">
                                <table class = "table">
                                    <thead>
                                    <tr>
                                        <th>
                                            #
                                        </th>
                                        <th>
                                            Product
                                        </th>
                                        <th>
                                            Payment Taken
                                        </th>
                                        <th>
                                            Status
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    <tr>
                                        <td>
                                            1
                                        </td>
                                        <td>
                                            TB - Monthly
                                        </td>
                                        <td>
                                            01/04/2012
                                        </td>
                                        <td>
                                            Default
                                        </td>
                                    </tr>
                                    <tr class = "table-active">
                                        <td>
                                            1
                                        </td>
                                        <td>
                                            TB - Monthly
                                        </td>
                                        <td>
                                            01/04/2012
                                        </td>
                                        <td>
                                            Approved
                                        </td>
                                    </tr>
                                    <tr class = "table-success">
                                        <td>
                                            2
                                        </td>
                                        <td>
                                            TB - Monthly
                                        </td>
                                        <td>
                                            02/04/2012
                                        </td>
                                        <td>
                                            Declined
                                        </td>
                                    </tr>
                                    <tr class = "table-warning">
                                        <td>
                                            3
                                        </td>
                                        <td>
                                            TB - Monthly
                                        </td>
                                        <td>
                                            03/04/2012
                                        </td>
                                        <td>
                                            Pending
                                        </td>
                                    </tr>
                                    <tr class = "table-danger">
                                        <td>
                                            4
                                        </td>
                                        <td>
                                            TB - Monthly
                                        </td>
                                        <td>
                                            04/04/2012
                                        </td>
                                        <td>
                                            Call in to confirm
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class = "col-md-4">
                                <div class = "col-md-8 col-md-offset-1 col-xs-11" id = "demo">
                                    <form class = "form-horizontal" id = "frm_payment" name = "frm_payment">
                                        <div class = "form-group" style = "margin-bottom: 0px;">
                                            <label class = "col-md-4 col-xs-4" for = "pay_method">결제수단</label>
                                            <select class = "col-md-8 col-xs-8" id = "pay_method"
                                                    ng-model = "payMethod"
                                                    ng-options = "m as m.name for m in pg.payMethod track by m.value">
                                            </select>
                                        </div>
                                        <div class = "form-group">
                                            <div class = "checkbox col-md-4 col-md-offset-3" style = "padding: 0px;">
                                                <label>
                                                    <input name = "use_escrow" ng-model = "use_escrow"
                                                           type = "checkbox">
                                                    <span id = "escrow-label"> 에스크로결제적용</span>
                                                </label>
                                            </div>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "merchant_uid">주문번호</label>
                                            <input class = "col-md-8 col-xs-8" id = "merchant_uid" name = "merchant_uid"
                                                   ng-model = "merchant_uid" type = "text"/>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "name">결제명</label>
                                            <input class = "col-md-8 col-xs-8" id = "name" name = "name" ng-model = "name"
                                                   type = "text"/>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "amount">금액</label>
                                            <input class = "col-md-8 col-xs-8" id = "amount" name = "amount" ng-model = "amount"
                                                   type = "tel"/>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "buyer_email">이메일주소</label>
                                            <input class = "col-md-8 col-xs-8" id = "buyer_email" name = "buyer_email"
                                                   ng-model = "buyer_email" type = "text"/>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "buyer_name">성함</label>
                                            <input class = "col-md-8 col-xs-8" id = "buyer_name" name = "buyer_name"
                                                   ng-model = "buyer_name" type = "text"/>
                                        </div>
                                        <div class = "form-group">
                                            <label class = "col-md-4 col-xs-4" for = "buyer_tel">전화번호</label>
                                            <input class = "col-md-8 col-xs-8" id = "buyer_tel" name = "buyer_tel"
                                                   ng-model = "buyer_tel" type = "tel"/>
                                        </div>
                                    </form>
                                    <pre id = "responser" ng-bind = "response" ng-show = "is_response"></pre>

                                    <div class = "col-md-3 col-xs-3"></div>
                                    <div class = "col-md-9 col-xs-9" style = "text-align:left">
                                        <div class = "newStyleBtnDiv">
                                            <button class = "confirm" ng-click = "payRequest()" type = "button">
                                                결제 테스트하기
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class = "col-md-2">
                    </div>
                </div>
            </div>
        </div>
    </div>


</article>


</body>
</html>