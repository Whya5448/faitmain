<!DOCTYPE html>
<html layout:decorate = "~{layout/default_layout}"
      xmlns:layout = "http://www.ultraq.net.nz/thymeleaf/layout">

<head>
    <meta charset = "UTF-8">
    <title>주문페이지</title>
    <!--  고유 CSS 추가 -->

    <!--  고유 스크립트 추가 -->
    <!-- jQuery -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!-- iamport.payment.js -->
    <script type="text/javascript" src="https://cdn.iamport.kr/js/iamport.payment.js"></script>

</head>
<body>

<!-- content -->
<article class = "py-5" layout:fragment = "content">
    <div class = "container">
        <div class = "wrap">
            <div class = "content_area">
                <div class = "content_main">
                    <!-- 회원 정보 -->
                    <div class = "member_info_div">
                        <table class = "table_text_align_center memberInfo_table">
                            <tbody>
                            <tr>
                                <th style = "width: 25%;">주문자</th>
                                <td style = "width: 10%;" th:text = "${buyer.id}">홍길동</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 배송지 정보 -->
                    <div class = "addressInfo_div">
                        <div class = "addressInfo_button_div">
                            <button class = "address_btn address_btn_1" onclick = "showAdress('1')" style = "background-color: #3c3838;">상용자 정보 주소록</button>
                            <button class = "address_btn address_btn_2" onclick = "showAdress('2')">직접 입력</button>
                        </div>
                        <div class = "addressInfo_input_div_wrap">
                            <div class = "addressInfo_input_div addressInfo_input_div_1" style = "display: block">
                                <table>
                                    <tbody>
                                    <tr>
                                        <th>이름</th>
                                        <td>[[${buyer.name}]]</td>
                                    </tr>
                                    <tr>
                                        <th>주소</th>
                                        <td>[[${buyer.userAddress1}]] [[${buyer.userAddress2}]]<br>[[${buyer.userAddress3}]]
                                            <input class = "selectAddress" type = "hidden" value = "T">
                                            <input class = "addressee_input" type = "hidden" th:value = "${buyer.name}">
                                            <input class = "address1_input" type = "hidden" th:value = "${buyer.userAddress1}">
                                            <input class = "address2_input" type = "hidden" th:value = "${buyer.userAddress2}">
                                            <input class = "address3_input" type = "hidden" th:value = "${buyer.userAddress3}">
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class = "addressInfo_input_div addressInfo_input_div_2">
                                <table>
                                    <colgroup>
                                        <col width = "25%">
                                        <col width = "*">
                                    </colgroup>
                                    <tbody>
                                    <tr>
                                        <th>이름</th>
                                        <td><input class = "addressee_input"></td>
                                    </tr>
                                    <tr>
                                        <th>주소</th>
                                        <td>
                                            <input class = "selectAddress" type = "hidden" value = "F">
                                            <input class = "address1_input" readonly = "readonly"> <a class = "address_search_btn" onclick = "execution_daum_address()">주소 찾기</a><br>
                                            <input class = "address2_input" readonly = "readonly"><br>
                                            <input class = "address3_input" readonly = "readonly">
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <!-- 상품 정보 -->
                    <div class = "orderGoods_div">
                        <!-- 상품 종류 -->
                        <div class = "goods_kind_div">
                            주문상품 <span class = "goods_kind_div_kind"></span>종 <span class = "goods_kind_div_count"></span>개
                        </div>
                        <!-- 상품 테이블 -->
                        <table class = "goods_subject_table">
                            <colgroup>
                                <col width = "15%">
                                <col width = "45%">
                                <col width = "40%">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>이미지</th>
                                <th>상품 정보</th>
                                <th>판매가</th>
                            </tr>
                            </tbody>
                        </table>
                        <table class = "goods_table">
                            <colgroup>
                                <col width = "15%">
                                <col width = "45%">
                                <col width = "40%">
                            </colgroup>
                            <tbody>
                            <th:block th:each="orderPageProduct: ${orderPageProductList}" th:if = "${#lists.size(orderPageProductList) > 0}">
                                <tr>
                                    <td>
                                        <div class = "image_wrap" th:text = "${orderPageProduct.productMainImage}"></div>
                                    </td>
                                    <td>[[${orderPageProduct.productName}]]</td>
                                    <td class = "goods_table_price_td">
                                        <th:block th:text = "${orderPageProduct.productOrderCount}"></th:block>
                                        <br>
                                        <th:block th:text = "${orderPageProduct.salePrice}"></th:block>
                                        <br>
                                        <th:block th:text = "${orderPageProduct.totalPrice}"></th:block>
                                        <br>[
                                        <th:block th:text = "${orderPageProduct.totalPoint}"></th:block>
                                        P]
                                        <input class = "individual_bookPrice_input" type = "hidden" value = "${ol.bookPrice}">
                                        <input class = "individual_salePrice_input" type = "hidden" value = "${ol.salePrice}">
                                        <input class = "individual_bookCount_input" type = "hidden" value = "${ol.bookCount}">
                                        <input class = "individual_totalPrice_input" type = "hidden" value = "${ol.salePrice * ol.bookCount}">
                                        <input class = "individual_point_input" type = "hidden" value = "${ol.point}">
                                        <input class = "individual_totalPoint_input" type = "hidden" value = "${ol.totalPoint}">
                                        <input class = "individual_bookId_input" type = "hidden" value = "${ol.bookId}">
                                    </td>
                                </tr>
                            </th:block>

                            </tbody>
                        </table>
                    </div>
                    <!-- 포인트 정보 -->
                    <div class = "point_div">
                        <div class = "point_div_subject">포인트 사용</div>
                        <table class = "point_table">
                            <colgroup>
                                <col width = "25%">
                                <col width = "*">
                            </colgroup>
                            <tbody>
                            <tr>
                                <th>포인트 사용</th>
                                <td>
                                    ${memberInfo.point} | <input class = "order_point_input" value = "0">원
                                    <a class = "order_point_input_btn order_point_input_btn_N" data-state = "N">모두사용</a>
                                    <a class = "order_point_input_btn order_point_input_btn_Y" data-state = "Y" style = "display: none;">사용취소</a>

                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 주문 종합 정보 -->
                    <div class = "total_info_div">
                        <!-- 가격 종합 정보 -->
                        <div class = "total_info_price_div">
                            <ul>
                                <li>
                                    <span class = "price_span_label">상품 금액</span>
                                    <span class = "totalPrice_span">100000</span>원
                                </li>
                                <li>
                                    <span class = "price_span_label">배송비</span>
                                    <span class = "delivery_price_span">100000</span>원
                                </li>
                                <li>
                                    <span class = "price_span_label">할인금액</span>
                                    <span class = "usePoint_span">100000</span>원
                                </li>
                                <li class = "price_total_li">
                                    <strong class = "price_span_label total_price_label">최종 결제 금액</strong>
                                    <strong class = "strong_red">
									<span class = "total_price_red finalTotalPrice_span">
										1500000
									</span>원
                                    </strong>
                                </li>
                                <li class = "point_li">
                                    <span class = "price_span_label">적립예정 포인트</span>
                                    <span class = "totalPoint_span">7960원</span>
                                </li>
                            </ul>
                        </div>
                        <!-- 버튼 영역 -->
                        <div class = "total_info_btn_div">
                            <a class = "order_btn">결제하기</a>
                        </div>
                    </div>

                </div>

                <!-- 주문 요청 form -->
                <form action = "/order" class = "order_form" method = "post">
                    <!-- 주문자 회원번호 -->
                    <input name = "memberId" type = "hidden" value = "${memberInfo.memberId}">
                    <!-- 주소록 & 받는이-->
                    <input name = "addressee" type = "hidden">
                    <input name = "memberAddr1" type = "hidden">
                    <input name = "memberAddr2" type = "hidden">
                    <input name = "memberAddr3" type = "hidden">
                    <!-- 사용 포인트 -->
                    <input name = "usePoint" type = "hidden">
                    <!-- 상품 정보 -->
                </form>

            </div>

        </div>
    </div>    <!-- class="wrap" -->
    </div>    <!-- class="wrapper" -->

    <button onclick = "requestPay()">결제하기</button>
</article>

<!-- javascript -->
<script th:inline="javascript">
    function requestPay() {

        // 결제 금액, 구매자의 이름, 이메일
        // const priceAmount = $('#totalPrice').val();
        // const buyerMemberEmail = $('#memberEmail').val();
        // const buyerMemberName = $('#memberName').val();
        // const form = document.getElementById("payment");

        const IMP = window.IMP;

        // IMP.request_pay(param, callback) 결제창 호출
        IMP.init('imp76668016');
        IMP.request_pay({ // param
            pg: "kakaopay.TC0ONETIME",
            pay_method: "card",
            merchant_uid: 'cart_' + new Date().getTime(),
            name: "Helpring 강의",
            amount: "priceAmount",
            buyer_email: "buyerMemberEmail",
            buyer_name: "buyerMemberName",

        }, function (rsp) { // callback

            /** 결제 검증 **/
            $.ajax({
                type: 'POST',
                url: '/verifyIamport/' + rsp.imp_uid,
                beforeSend: function (xhr) {
                    xhr.setRequestHeader(header, token);
                }
            }).done(function (result) {

                // rsp.paid_amount와 result.response.amount(서버 검증) 비교 후 로직 실행
                if (rsp.paid_amount === result.response.amount) {
                    alert("결제가 완료되었습니다.");
                    $.ajax({
                        type: 'POST',
                        url: '/lecture/payment',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader(header, token);
                        }
                    }).done(function () {
                        window.location.reload();
                    }).fail(function (error) {
                        alert(JSON.stringify(error));
                    })
                } else {
                    alert("결제에 실패했습니다." + "에러코드 : " + rsp.error_code + "에러 메시지 : " + rsp.error_message);

                }
            })
        });
    }



    //
    // $(document).ready(function () {
    //     /* 주문 조합정보란 최신화 */
    //     setTotalInfo();
    //     /* 이미지 삽입 */
    //     $(".image_wrap").each(function (i, obj) {
    //         const bobj = $(obj);
    //         if (bobj.data("bookid")) {
    //             const uploadPath = bobj.data("path");
    //             const uuid = bobj.data("uuid");
    //             const fileName = bobj.data("filename");
    //             const fileCallPath = encodeURIComponent(uploadPath + "/s_" + uuid + "_" + fileName);
    //             $(this).find("img").attr('src', '/display?fileName=' + fileCallPath);
    //         } else {
    //             $(this).find("img").attr('src', '/resources/img/goodsNoImage.png');
    //         }
    //     });
    // });


    /* 포인트 입력 */
    //0 이상 & 최대 포인트 수 이하
    $(".order_point_input").on("propertychange change keyup paste input", function () {
        const maxPoint = parseInt('${memberInfo.point}');

        let inputValue = parseInt($(this).val());

        if (inputValue < 0) {
            $(this).val(0);
        } else if (inputValue > maxPoint) {
            $(this).val(maxPoint);
        }

        /* 주문 조합정보란 최신화 */
        setTotalInfo();

    });
    /* 포인트 모두사용 취소 버튼
     * Y: 모두사용 상태 / N : 모두 취소 상태
     */
    $(".order_point_input_btn").on("click", function () {
        const maxPoint = parseInt('${memberInfo.point}');

        let state = $(this).data("state");

        if (state == 'N') {
            console.log("n동작");
            /* 모두사용 */
            //값 변경
            $(".order_point_input").val(maxPoint);
            //글 변경
            $(".order_point_input_btn_Y").css("display", "inline-block");
            $(".order_point_input_btn_N").css("display", "none");
        } else if (state == 'Y') {
            console.log("y동작");
            /* 취소 */
            //값 변경
            $(".order_point_input").val(0);
            //글 변경
            $(".order_point_input_btn_Y").css("display", "none");
            $(".order_point_input_btn_N").css("display", "inline-block");
        }

        /* 주문 조합정보란 최신화 */
        setTotalInfo();

    });

    /* 총 주문 정보 세팅(배송비, 총 가격, 마일리지, 물품 수, 종류) */
    function setTotalInfo() {
        let totalPrice = 0;				// 총 가격
        let totalCount = 0;				// 총 갯수
        let totalKind = 0;				// 총 종류
        let totalPoint = 0;				// 총 마일리지
        let deliveryPrice = 0;			// 배송비
        let usePoint = 0;				// 사용 포인트(할인가격)
        let finalTotalPrice = 0; 		// 최종 가격(총 가격 + 배송비)

        $(".goods_table_price_td").each(function (index, element) {
            // 총 가격
            totalPrice += parseInt($(element).find(".individual_totalPrice_input").val());
            // 총 갯수
            totalCount += parseInt($(element).find(".individual_bookCount_input").val());
            // 총 종류
            totalKind += 1;
            // 총 마일리지
            totalPoint += parseInt($(element).find(".individual_totalPoint_input").val());
        });
        /* 배송비 결정 */
        if (totalPrice >= 30000) {
            deliveryPrice = 0;
        } else if (totalPrice == 0) {
            deliveryPrice = 0;
        } else {
            deliveryPrice = 3000;
        }

        finalTotalPrice = totalPrice + deliveryPrice;

        /* 사용 포인트 */
        usePoint = $(".order_point_input").val();

        finalTotalPrice = totalPrice - usePoint;

        /* 값 삽입 */
        // 총 가격
        $(".totalPrice_span").text(totalPrice.toLocaleString());
        // 총 갯수
        $(".goods_kind_div_count").text(totalCount);
        // 총 종류
        $(".goods_kind_div_kind").text(totalKind);
        // 총 마일리지
        $(".totalPoint_span").text(totalPoint.toLocaleString());
        // 배송비
        $(".delivery_price_span").text(deliveryPrice.toLocaleString());
        // 최종 가격(총 가격 + 배송비)
        $(".finalTotalPrice_span").text(finalTotalPrice.toLocaleString());
        // 할인가(사용 포인트)
        $(".usePoint_span").text(usePoint.toLocaleString());

    }


    /* 주문 요청 */
    $(".order_btn").on("click", function () {
        /* 주소 정보 & 받는이*/
        $(".addressInfo_input_div").each(function (i, obj) {
            if ($(obj).find(".selectAddress").val() === 'T') {
                $("input[name='addressee']").val($(obj).find(".addressee_input").val());
                $("input[name='memberAddr1']").val($(obj).find(".address1_input").val());
                $("input[name='memberAddr2']").val($(obj).find(".address2_input").val());
                $("input[name='memberAddr3']").val($(obj).find(".address3_input").val());
            }
        });

        /* 사용 포인트 */
        $("input[name='usePoint']").val($(".order_point_input").val());

        /* 상품정보 */
        let form_contents = '';
        $(".goods_table_price_td").each(function (index, element) {
            let bookId = $(element).find(".individual_bookId_input").val();
            let bookCount = $(element).find(".individual_bookCount_input").val();
            let bookId_input = "<input name='orders[" + index + "].bookId' type='hidden' value='" + bookId + "'>";
            form_contents += bookId_input;
            let bookCount_input = "<input name='orders[" + index + "].bookCount' type='hidden' value='" + bookCount + "'>";
            form_contents += bookCount_input;
        });
        $(".order_form").append(form_contents);

        /* 서버 전송 */
        $(".order_form").submit();

    });
</script>


</body>
</html>